From 84d022653052c499d6da60e7bb4d1ce4dcdb743c Mon Sep 17 00:00:00 2001
From: must_eat <mss@tutanota.de>
Date: Tue, 25 Oct 2022 06:44:35 +0300
Subject: [PATCH 16/16] fix dbus.

---
 toolkit/moz.configure | 32 ++++++++++++++++++++------------
 1 file changed, 20 insertions(+), 12 deletions(-)

diff --git a/toolkit/moz.configure b/toolkit/moz.configure
index 164b518a93..bb64c854dc 100644
--- a/toolkit/moz.configure
+++ b/toolkit/moz.configure
@@ -2360,18 +2360,6 @@ with only_when(compile_environment & target_is_windows):
     )
     set_config("MOZ_D3DCOMPILER_VISTA_DLL_PATH", d3d_compiler_dll.path)
 
-# Remoting protocol support
-# ==============================================================
-
-
-@depends(toolkit)
-def has_remote(toolkit):
-    if toolkit in ("gtk", "windows", "cocoa"):
-        return True
-
-
-set_config("MOZ_HAS_REMOTE", has_remote)
-set_define("MOZ_HAS_REMOTE", has_remote)
 
 # RLBox Library Sandboxing wasm support
 # ==============================================================
@@ -2907,6 +2895,26 @@ with only_when(toolkit_gtk):
         set_config("MOZ_ENABLE_DBUS", True)
         set_define("MOZ_ENABLE_DBUS", True)
 
+# Remoting protocol support
+# ==============================================================
+
+@depends(
+    toolkit,
+    depends("--enable-dbus", when=toolkit_gtk)(lambda x: x),
+    depends(wayland_headers, when=toolkit_gtk)(lambda x: x),
+    depends(x11_headers, when=toolkit_gtk)(lambda x: x),
+)
+def has_remote(toolkit, dbus, wayland, x11):
+    if toolkit in ("windows", "cocoa"):
+        return True
+    if toolkit == "gtk":
+        if not dbus and wayland and not x11:
+            return
+        return True
+
+
+set_config("MOZ_HAS_REMOTE", has_remote)
+set_define("MOZ_HAS_REMOTE", has_remote)
 
 # Necko's wifi scanner
 # ==============================================================
-- 
2.38.0

