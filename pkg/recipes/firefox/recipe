# 1 > env vars
#t61cf="-march=penryn -mtune=penryn -mno-avx -mno-aes -mno-sse4a -mno-sse4.2"
#t61rf="-Ctarget-cpu=penryn -Ctarget-feature=-avx -Ctarget-feature=-aes"
#t61rf="${t61rf} -Ctarget-feature=-sse4a -Ctarget-feature=-sse4.2"
#
#export   CFLAGS="$(echo "${CFLAGS}"   \
# | sed "s/-march=native -mtune=native/${t61cf}/")"
#export CXXFLAGS="$(echo "${CXXFLAGS}" \
# | sed "s/-march=native -mtune=native/${t61cf}/")"
export  LDFLAGS="$(echo "${LDFLAGS}"  \
 | sed 's/,--thinlto-cache-dir=\/mss\/work\/ltocache//g')"

penis="/mss/work/table/KEK"
export                 CFLAGS="${CFLAGS}   -L${penis}/lib -I${penis}/include"
export               CXXFLAGS="${CXXFLAGS} -L${penis}/lib -I${penis}/include"
export                LDFLAGS="${LDFLAGS},-rpath=/opt/firefox-91.3.0esr/lib,--enable-new-dtags"

#                   RUSTFLAGS="-Clinker=${CC} ${t61rf} -Lnative=$(llvm-config --libdir)"
                    RUSTFLAGS="-Clinker=${CC} -Ctarget-cpu=native -Lnative=$(llvm-config --libdir)"
export              RUSTFLAGS="${RUSTFLAGS} -Cdebuginfo=0 -Cdebug-assertions=off"
export         BINDGEN_CFLAGS="${CFLAGS}"

export                   PATH="${penis}/bin:${PATH}"
export        PKG_CONFIG_PATH="${PKG_CONFIG_PATH}:${penis}/lib/pkgconfig"
export        LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:${penis}/lib"
export           LIBRARY_PATH="${LD_LIBRARY_PATH}"

export              CXXSTDLIB="c++"
export            RUST_TARGET="${CHOST}"
export             MOZ_NOSPAM=1
export        MOZ_DEBUG_FLAGS="-g0"
export MACH_USE_SYSTEM_PYTHON=1

# 2 > static libXt
tar xf /mss/work/sauces/xorg-libs/libXt-1.2.1.tar.bz2
cd     libXt-1.2.1/

./configure \
 --build=$CBUILD             \
 --host=$CHOST               \
 --prefix="${penis}"         \
 --enable-static             \
 --disable-shared            \
 --sysconfdir=/etc           \
 --localstatedir=/var        \
 --enable-malloc0returnsnull \
 --without-fop               \
 --without-glib              \
 --without-perl              \
 --without-xmlto             \
 --without-xsltproc          \
 --disable-specs             \
 --disable-unit-tests

make
make install

cd ../; rm -rf libXt-1.2.1/

# 3 > autoconf 2.13
tar xf /mss/work/sauces/autoconf-2.13.tar.gz
cd     autoconf-2.13/

configtomusl

./configure \
 --build=$CBUILD     \
 --host=$CHOST       \
 --prefix="${penis}" \
 --program-suffix="-2.13"

make
make install

cd ../; rm -rf autoconf-2.13/

# 4 > yasm
tar xf /mss/work/sauces/yasm-1.3.0.tar.gz
cd     yasm-1.3.0/

configtomusl

./configure \
 --build=$CBUILD \
 --host=$CHOST   \
 --prefix="${penis}"

make
make install

cd ../; rm -rf yasm-1.3.0/

# 5 > zip
tar xf /mss/work/sauces/zip30.tar.gz
cd     zip30/

make LOCAL_ZIP="${CFLAGS}" -f unix/Makefile generic
make prefix="${penis}"     -f unix/Makefile install

cd ../; rm -rf zip30/

# 6 > extraction
tar xf /mss/work/sauces/firefox-91.3.0esr.source.tar.xz
cd     firefox-91.3.0/

# 7 > apply patches
pdir="/mss/repo/pkg/recipes/firefox/patches"
for file in "${pdir}"/*.patch; do patch -p1 < "${file}"; done

# 8 > nuke addons and pocket
rm -rf \
 browser/components/pocket                                        \
 browser/extensions/{doh-rollout,pictureinpicture,proxy-failover} \
 browser/extensions/{report-site-issue,screenshots,translations,webcompat}

# 9 > clear sums
for sum in target-lexicon-0.9.0; do
 sed -i 's/\("files":{\)[^}]*/\1/'  third_party/rust/${sum}/.cargo-checksum.json
done

# 10 > clear the default bookmarks
fdir="/mss/repo/pkg/recipes/firefox/files"
cp -vf "${fdir}"/bookmarks.html.in  browser/locales/generic/profile/bookmarks.html.in

# 11 > clear search engines
cp -vf "${fdir}"/search-config.json services/settings/dumps/main/search-config.json

# 12 > remove prebuilt binaries
find ./third_party -type f \( -name '*.so' -o -name '*.o' \) -print -delete

# 13 > start the build
cp -v "${fdir}"/mozconfig .
_echoflags="$(echo ${CXXFLAGS} | sed 's/\//\\\//g')"
sed -i -e "s/REPLACEMEYOUWONT/${_echoflags}/g" mozconfig
sed -i -e "s/JOBCOUNTREPLACE/${ajobcount}/g" mozconfig
unset _echoflags

time ./mach build

# 14 > install
instdir="${PWD}/KEK/opt/firefox-91.3.0esr"
DESTDIR="${PWD}/dummyinstall" ./mach install

mkdir "${instdir}"/bin
mv    "${PWD}/dummyinstall"/opt/firefox-91.3.0esr/lib/firefox "${instdir}"/lib
pushd "${instdir}"/bin
ln -sfv ../lib/firefox firefox
popd

install -v -Dm644 "${fdir}"/vendor.js     \
 "${instdir}"/lib/browser/defaults/preferences/vendor.js
install -v -Dm644 "${fdir}"/policies.json \
"${instdir}"/lib/distribution/policies.json
