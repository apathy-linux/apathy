# 1
money="/mss/work/table/INS"
export          CFLAGS="${CFLAGS}   -L${money}/lib -I${money}/include -fPIC"
export        CXXFLAGS="${CXXFLAGS} -L${money}/lib -I${money}/include -fPIC"
export            PATH="${PATH}:${money}/bin"
export PKG_CONFIG_PATH="${PKG_CONFIG_PATH}:${money}/lib/pkgconfig"
export    LIBRARY_PATH="${LIBRARY_PATH}:${money}/lib"

# 2 > musl-fts
#  checking for library containing fts_open... no
#  checking for fts_open... no
#
# the configure script checks for a library containing fts functions, and if
# found, it does add -lfts to Makefiles being generated but in repo.c, fts.h is
# directly included without any guards, and the code uses fts functions
# directly.
#
# in systems like musl hosts where an external fts implementation needs to be
# brought in, this causes the following error:
#
#  repo.c:28:10: fatal error: 'fts.h' file not found
#  #include <fts.h>
#
# building musl-fts (https://github.com/void-linux/musl-fts) in my case does
# fix the issue.
#
# if a lib containing fts functions are not found, the configure should
# register that as a fatal error to prevent this build breakage.
tar xf /mss/work/sauces/musl-fts-1.2.7.tar.gz
cd     musl-fts-1.2.7/

autoreconf -fvi

CFLAGS="${CFLAGS} -fno-builtin" \
./configure \
 --build=$CBUILD     \
 --host=$CHOST       \
 --prefix="${money}" \
\
 --enable-static     \
 --disable-shared

make
make install

cd ../; rm -rf musl-fts-1.2.7/

# 3 > libressl
# if only libtls is built from libressl (with --enable-libtls-only), (libcrypto
# and libssl in this case is provided by the system openssl 3.0.8), the build
# fails with the following symbol collision:
#  ld.lld: error: duplicate symbol: ASN1_time_tm_cmp
#  >>> defined in ../compat/.libs/libcompat.a(a_time_tm.o)
#  >>> defined in /mss/work/table/INS/lib/libtls.a(libcrypto_la-a_time_tm.o)
#
#  ld.lld: error: duplicate symbol: ASN1_time_parse
#  >>> defined in ../compat/.libs/libcompat.a(a_time_tm.o)
#  >>> defined in /mss/work/table/INS/lib/libtls.a(libcrypto_la-a_time_tm.o)
#  clang-15: error: linker command failed with exit code 1 (use -v to see invocation)
#
# if both libcrypto and libssl is built alongside libtls from libressl, the
# pkg-config calls made by configure will pick the libs provided by the libressl
# installation, and the collission will not happen.
tar xf /mss/work/sauces/libressl-3.7.0.tar.gz
cd     libressl-3.7.0/

./configure \
 --build=$CBUILD       \
 --host=$CHOST         \
 --prefix="${money}"   \
\
 --enable-asm          \
 --enable-static       \
 --disable-extratests  \
 --disable-libtls-only \
 --disable-nc          \
 --disable-shared      \
 --disable-tests       \
 --disable-windows-ssp

make
make install

cd ../; rm -rf libressl-3.7.0/

# 4
tar xf /mss/work/sauces/rpki-client-8.2.tar.gz
cd     rpki-client-8.2/

./configure \
 --build=$CBUILD                 \
 --host=$CHOST                   \
 --prefix="/opt/rpki-client-8.2" \
 --localstatedir=/var            \
\
 --with-user="mss"

make
