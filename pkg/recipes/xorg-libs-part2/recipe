# 1 > env vars
penis="/mss/work/table/KEK"
instdir="/mss/work/XorgLIBS2"
ft_int="-DDEFAULT_TT_INTERPRETER_VERSION=TT_INTERPRETER_VERSION_38"
export          CFLAGS="${CFLAGS}   -I${penis}/include -L/${penis}/lib ${ft_int}"
export        CXXFLAGS="${CXXFLAGS} -I${penis}/include -L/${penis}/lib ${ft_int}"
export PKG_CONFIG_PATH="${PKG_CONFIG_PATH}:${penis}/lib/pkgconfig"
export    LIBRARY_PATH="${LIBRARY_PATH}:${penis}/lib"

# 2 > system libpng
tar xf /mss/work/sauces/libpng-1.6.37.tar.xz
cd     libpng-1.6.37/

pdir="/mss/repo/pkg/recipes/xorg-libs-part2/patches"
patch -p1 < "${pdir}"/0001-libpng-apng.patch

LIBS=-lpthread \
./configure \
 --build=$CBUILD \
 --host=$CHOST   \
 --prefix=/usr   \
 --disable-static

make
make DESTDIR="${instdir}" install
doas -- make install

cd ../; rm -rf libpng-1.6.37/

# 3 > system glib
tar xf /mss/work/sauces/glib-2.73.3.tar.xz
cd     glib-2.73.3/

sed -i -e 's/libmount_dep.found()/false/' meson.build
touch fuzzing/meson.build

mkdir build
cd    build

CFLAGS="${CFLAGS} -std=gnu11" \
meson --buildtype=plain \
 --prefix=/usr           \
 -Dgtk_doc=false         \
 -Dinstalled_tests=false \
 -Dlibmount=disabled     \
 -Dman=false             \
 -Dnls=disabled          \
 -Dtests=false           \
 -Dxattr=false           \
..

samu
DESTDIR="${instdir}" samu install
doas -- samu install

cd ../../; rm -rf glib-2.73.3/

# 4 > penis freetype (w/o harfbuzz)
tar xf /mss/work/sauces/freetype-2.12.1.tar.xz
cd     freetype-2.12.1/

patch -p1 < "${pdir}"/0002-freetype-enable-long-pcf-family-names.patch

./configure               \
 --build=$CBUILD          \
 --host=$CHOST            \
 --prefix="${penis}"      \
 --enable-freetype-config \
 --with-harfbuzz=no       \
 --disable-static

make
make install
cd ../; rm -rf freetype-2.12.1/

# 5 > penis harfbuzz
tar xf /mss/work/sauces/harfbuzz-5.1.0.tar.xz
cd     harfbuzz-5.1.0/

mkdir build
cd    build

meson --buildtype=plain \
 --prefix="${penis}"      \
 -Dcairo=disabled         \
 -Dglib=enabled           \
 -Dgobject=disabled       \
 -Dicu=disabled           \
 -Dgraphite=disabled      \
 -Dfreetype=enabled       \
 -Dtests=disabled         \
 -Dintrospection=disabled \
 -Ddocs=disabled          \
 -Dbenchmark=disabled     \
 -Dicu_builtin=false      \
 -Dexperimental_api=false \
..

samu
samu install

cd ../../; rm -rf harfbuzz-5.1.0/

# 6 > system freetype (w/ harfbuzz)
tar xf /mss/work/sauces/freetype-2.12.1.tar.xz
cd     freetype-2.12.1/

patch -p1 < "${pdir}"/0002-freetype-enable-long-pcf-family-names.patch

./configure               \
 --build=$CBUILD          \
 --host=$CHOST            \
 --prefix=/usr            \
 --enable-freetype-config \
 --with-harfbuzz=yes      \
 --disable-static

make
make DESTDIR="${instdir}" install
doas -- make install

cd ../ && rm -rf freetype-2.12.1/

# 7 > system fontconfig
tar xf /mss/work/sauces/fontconfig-2.14.0.tar.xz
cd     fontconfig-2.14.0/

./configure           \
 --build=$CBUILD      \
 --host=$CHOST        \
 --prefix=/usr        \
 --localstatedir=/var \
 --sysconfdir=/etc    \
 --disable-docs       \
 --disable-nls        \
 --with-xmldir=/etc/fonts

make
make DESTDIR="${instdir}" install
doas -- make install

cd ../; rm -rf fontconfig-2.14.0/

# 8 > system pixman
tar xf /mss/work/sauces/pixman-0.40.0.tar.gz
cd     pixman-0.40.0/

patch -p1 < "${pdir}"/0003-pixman-fix-clang-lto.patch

mkdir build
cd    build

meson --buildtype=plain \
 --prefix=/usr            \
 -Dloongson-mmi=disabled  \
 -Dmmx=enabled            \
 -Dsse2=enabled           \
 -Dssse3=enabled          \
 -Dvmx=disabled           \
 -Darm-simd=disabled      \
 -Dneon=disabled          \
 -Diwmmxt=disabled        \
 -Diwmmxt2=false          \
 -Dmips-dspr2=disabled    \
 -Dgnu-inline-asm=enabled \
 -Dopenmp=enabled         \
 -Dtimers=false           \
 -Dgnuplot=false          \
 -Dgtk=disabled           \
 -Dlibpng=enabled         \
..

samu
DESTDIR="${instdir}" samu install
doas -- samu install

cd ../../; rm -rf pixman-0.40.0/

# 9 > system cairo
tar xf /mss/work/sauces/cairo-1.17.6.tar.xz
cd     cairo-1.17.6/

sed -i "s/BUILD_SPHINX_TRUE=/BUILD_SPHINX_TRUE='#'/"   configure
sed -i "s/BUILD_SPHINX_FALSE='#'/BUILD_SPHINX_FALSE=/" configure
sed -i 's/test perf//g' Makefile.in

ax_cv_c_float_words_bigendian=no \
./configure            \
 --build=$CBUILD       \
 --host=$CHOST         \
 --prefix=/usr         \
 --disable-static      \
 --enable-tee          \
 --enable-gl           \
 --enable-egl          \
 --enable-xlib-xcb     \
 --enable-xcb          \
 --enable-xlib-xrender \
 --enable-xlib         \
 --disable-trace       \
 --disable-valgrind    \
 --disable-gtk-doc-html

make
make DESTDIR="${instdir}" install
doas -- make install

cd ../; rm -rf cairo-1.17.6/

# 10 > system harfbuzz
tar xf /mss/work/sauces/harfbuzz-5.1.0.tar.xz
cd     harfbuzz-5.1.0/

mkdir build
cd    build

meson --buildtype=plain \
 --prefix="/usr"          \
 -Dcairo=enabled          \
 -Dglib=enabled           \
 -Dgobject=disabled       \
 -Dicu=disabled           \
 -Dgraphite=disabled      \
 -Dfreetype=enabled       \
 -Dtests=disabled         \
 -Dintrospection=disabled \
 -Ddocs=disabled          \
 -Dbenchmark=disabled     \
 -Dicu_builtin=false      \
 -Dexperimental_api=false \
..

samu
DESTDIR="${instdir}" samu install
doas -- samu install

cd ../../; rm -rf harfbuzz-5.1.0/

# 11 > cleanup
doas -- rm -rfv \
 /etc/fonts                 \
 /usr/share/bash-completion \
 /usr/share/doc             \
 /usr/share/fontconfig      \
 /usr/share/gdb             \
 /usr/share/gettext         \
 /usr/share/gtk-doc         \
 /usr/share/man             \
 /var/cache/fontconfig

doas -- cleanup

# 12 > copy the clean fontconfig config
doas -- cp -rv \
 /mss/repo/dir/etc/fonts /etc/fonts
